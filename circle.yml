
dependencies:
 pre:
  - sudo apt-get install gdebi-core
  - sudo apt-get remove erlang-appmon erlang-asn1 erlang-base-hipe erlang-base
  - wget http://packages.erlang-solutions.com/site/esl/esl-erlang/FLAVOUR_3_general/esl-erlang_17.5.3-1~ubuntu~precise_amd64.deb
  - sudo gdebi -n *.deb
  - sudo find -L /usr/lib/erlang/man -type l -exec rm {} \+

test:
 override:
  - ./circleci/prepare_env.sh
  - sudo apt-get install nmap
  - ssh node1 'sudo apt-get install nmap'
  - ssh node2 'sudo apt-get install nmap'
  - ssh node3 'sudo apt-get install nmap'
  - nmap node1
  - nmap node2
  - nmap node3
  - ssh node1 'nmap node1'
  - ssh node1 'nmap node2'
  - ssh node1 'nmap node3'
  - sudo pip install -r requirements.txt
  - echo '[{mzbench_api, [{mzbench_git, "git://github.com/ethercrow/mzbench"}]}].' | tee server/server.config
  - ./bin/mzbench start_server --config server/server.config
  - ./bin/mzbench start --nodes=node1,node2,node3 --node_commit=circleci examples/round_robin.erl
  - ./bin/mzbench log 0
  - for l in server/log/*; do echo $l && cat $l; done;